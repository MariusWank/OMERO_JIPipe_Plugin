<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JIPipeRunner Configuration</title>
  <!-- Link to external CSS for styling -->
  <style>
    :root {
      /* Color palette */
      --color-bg: #fff;
      --color-border: #e0e0e0;
      --color-start-button: #25ae03;
      --color-start-button-hover: #006a15;
      --color-stop-button: #eb2b2b;
      --color-stop-button-hover: #891717;
      --color-error: #d32f2f;
      --color-panel-bg: #fafafa;
      --color-text: #333;

      /* Spacing scale */
      --space-sm: 0.25rem;
      --space-md: 0.75rem;
      --space-lg: 1rem;

      /* Typography (scaled down ~10%) */
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --font-size-base: 11px;
      --font-size-label: 0.85rem;
    }

    #jipipe_form_container {
      background-color: var(--color-bg);
      box-sizing: border-box;
      color: var(--color-text);
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      line-height: 1.4;
      margin: 0;
      overflow-y: auto;
      flex: 1 1 auto;
    }

    #jipipe_runner_container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: var(--space-lg);
    }

    #jipipe_form_container section {
      background: var(--color-panel-bg);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      margin-bottom: var(--space-lg);
      padding: var(--space-md);
    }

    #jipipe_form_container h1 {
      align-self: center;
      font-size: 1.6rem;
      font-weight: 600;
      margin: 0 0 var(--space-sm);
    }

    #jipipe_form_container section h2 {
      font-size: 1.1rem;
      margin-bottom: var(--space-sm);
    }

    #jipipe_form_container .input-row {
      display: flex;
      flex-direction: column;
      margin-bottom: var(--space-sm);
    }

    #jipipe_form_container .input-row label {
      font-size: var(--font-size-label);
      font-weight: 600;
      margin-bottom: var(--space-sm);
    }

    #jipipe_form_container .input-row input {
      border: 1px solid var(--color-border);
      border-radius: 3px;
      font-size: var(--font-size-base);
      max-width: 350px;
      padding: var(--space-sm);
      width: 100%;
    }

    #jipipe_form_container #startRunnerBtn {
      background-color: var(--color-start-button);
      border: none;
      border-radius: 3px;
      color: #fff;
      cursor: pointer;
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin: 0 auto var(--space-lg);
      padding: var(--space-sm) var(--space-md);
      text-align: center;
      transition: background-color 0.2s ease-in-out;
    }

    #jipipe_form_container #startRunnerBtn:hover {
      background-color: var(--color-start-button-hover);
      outline: none;
    }

    #jipipe_form_container #stopRunnerBtn {
      background-color: var(--color-stop-button);
      border: none;
      border-radius: 3px;
      color: #fff;
      cursor: pointer;
      display: none;
      font-size: 0.9rem;
      font-weight: 600;
      margin: 0 auto var(--space-lg);
      padding: var(--space-sm) var(--space-md);
      text-align: center;
      transition: background-color 0.2s ease-in-out;
    }

    #jipipe_form_container #stopRunnerBtn:hover {
      background-color: var(--color-stop-button-hover);
      outline: none;
    }

    #jipipe_form_container .log-container {
      max-height: 250px;
      min-height: 250px;
      overflow-x: hidden;
      overflow-y: auto;
    }

    #jipipe_form_container #logOutput {
      border: 1px solid var(--color-border);
      margin: 0;
      min-height: 225px;
      overflow-x: auto;
      overflow-y: auto;
      padding: 0.5rem;
      white-space: pre;
    }

    #jipipe_form_container .error {
      color: var(--color-error);
      font-weight: 600;
    }

    #jipipe_form_container .dot-animation {
      font-style: italic;
    }

    /* Red cross button styling */
    .cancel-btn {
      background: none;
      border: none;
      color: red;
      font-size: 1.2em;
      cursor: pointer;
      margin-left: 8px;
    }
    #running-jobs ul {
      list-style: none;
      padding: 0;
    }
    #running-jobs li {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    #running-jobs span.job-id {
      font-family: monospace;
    }

    #right_panel {
      box-shadow: inset 1px 0 0 hsl(210, 10%, 85%);
      bottom: 0;
      overflow: auto;
      right: 0;
      top: 0;
      width: 400px;
    }

    #center_container {
      right: 399px;
    }

    .tooltip-container {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .tooltip {
    position: relative;
    display: inline-block;
    width: 17px;
    height: 17px;
    background-color: #ddd;
    color: black;
    border-radius: 50%;
    text-align: center;
    font-weight: bold;
    cursor: pointer;
    font-size: 13px;
    line-height: 17px;
    align-self: baseline;
  }

  .tooltip:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 110%;
    left: 50%;
    background-color: #333;
    color: #fff;
    padding: 6px 8px;
    border-radius: 4px;
    white-space: nowrap;
    z-index: 1;
    font-size: 12px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    text-align: left;
    white-space: normal; /* allow wrapping */
    width: max-content;
    max-width: 325px;
  }
  </style>
</head>
<body>
  <div id="jipipe_runner_container">
    <h1>JIPipeRunner Configuration</h1>

    <!-- Section: Running jobs -->
    <section id="running-jobs">
      <h2>Running Jobs</h2>
      <ul id="runningJobsList">
        <!-- Dynamically populated -->
      </ul>
    </section>

    <!-- Section: Summary of node counts -->
    <section id="file_info">
      <h2>Node Summary</h2>
      <!-- Total, input, and output node counts are inserted here -->
    </section>

    <!-- Section: Input nodes (dataset IDs) -->
    <section id="input">
      <h2>Input Node Configuration</h2>
      <p>Enter comma-separated dataset IDs for each input node:</p>
      <!-- Input fields for dataset IDs will be generated here -->
    </section>

    <!-- Section: Custom parameters -->
    <section id="parameters">
      <h2>Parameter Configuration</h2>
      <p>Enter parameter values below:</p>
      <!-- Parameter input fields will be generated here -->
    </section>

    <div style="text-align: center; margin-bottom: 20px;">
      <button id="startRunnerBtn">Start JIPipeRunner</button>
      <button id="stopRunnerBtn" style="display:none;">Stop JIPipeRunner</button>
    </div>

    <!-- Section: Job output logs -->
    <section id="results">
      <div class="log-container">
        <pre id="logOutput"></pre>
      </div>
    </section>
  </div>

  <script>
    (async function () {
      const paramKeyByNodeUuid = {};
      let pipelineConfig = null;
      const activeJobs = new Set();

      function getCookieValue(name) {
        let cookieValue = null;
        document.cookie.split(';').forEach(cookie => {
          const [key, val] = cookie.trim().split('=');
          if (key === name) {
            cookieValue = decodeURIComponent(val);
          }
        });
        return cookieValue;
      }
      const csrftoken = getCookieValue('csrftoken');

      async function loadRunningJobs() {
      try {
        const resp = await fetch('/JIPipeRunner/list_jipipe_jobs/', {
          credentials: 'same-origin'
        });
        if (resp.ok) {
          const { job_ids } = await resp.json();
          job_ids.forEach(jobId => addRunningJob(jobId));
        } else {
          console.warn('Unable to load running jobs:', resp.status);
        }
      } catch (err) {
        console.error('Error fetching running jobs:', err);
      }
    }
      await loadRunningJobs();

      /**
       * Add a job entry to the running jobs list
       */
      function addRunningJob(jobId) {
        if (activeJobs.has(jobId)) return;
        activeJobs.add(jobId);
        const list = document.getElementById('runningJobsList');
        const li = document.createElement('li');
        li.id = `job-${jobId}`;
        li.innerHTML = `
          <span class="job-id">${jobId}</span>
          <button class="cancel-btn" title="Cancel job">&#10006;</button>
        `;
        const btn = li.querySelector('.cancel-btn');
        btn.addEventListener('click', () => {
          if (confirm(`Are you sure you want to cancel job ${jobId}?`)) {
            stopPipelineJob(jobId);
            removeRunningJob(jobId);
          }
        });
        list.appendChild(li);
      }
      /**
       * Remove a job entry from the running jobs list
       */
      function removeRunningJob(jobId) {
        activeJobs.delete(jobId);
        const el = document.getElementById(`job-${jobId}`);
        if (el) el.remove();
      }
      
      async function fetchPipelineConfig(projectId) {
        const response = await fetch(`/JIPipeRunner/get_jipipe_config/${projectId}/json/`);
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        return response.json();
      }

      function displayNodeSummary(nodesMap) {
        const container = document.getElementById('file_info');
        const allNodes = Object.values(nodesMap);
        const inputCount = allNodes.filter(node => node['jipipe:alias-id']?.includes('define-dataset-ids')).length;
        const outputCount = allNodes.filter(node => node['jipipe:alias-id']?.includes('upload')).length;
        container.innerHTML += `<p>Total nodes: ${allNodes.length}</p>`;
        container.innerHTML += `<p>Input nodes: ${inputCount}</p>`;
        container.innerHTML += `<p>Output nodes: ${outputCount}</p>`;
      }

      function createDatasetInputFields(nodesMap) {
        const container = document.getElementById('input');
        Object.entries(nodesMap).forEach(([uuid, node]) => {
          if (node['jipipe:alias-id']?.includes('define-dataset-ids')) {
            const row = document.createElement('div');
            row.className = 'input-row';
            const inputId = `dataset-id-${uuid}`;
            const existingIds = (node['dataset-ids'] || []).join(', ');
            row.innerHTML = `
              <label for="${inputId}">${node['jipipe:node:name']}:</label>
              <input type="text"
                     id="${inputId}"
                     name="datasetIds"
                     placeholder="${existingIds}">
            `;
            container.appendChild(row);
          }
        });
      }

      function createParameterFields(paramsMetadata, nodesMap) {
        const container = document.getElementById('parameters');
        const groups = paramsMetadata['exported-parameters']['parameter-reference-groups'];
        groups.forEach(group => {
          group.content.forEach(item => {
            // Get the name and path of the node
            const [uuid, paramKey] = item.path.split('/');
            paramKeyByNodeUuid[uuid] = paramKey;
            const defaultValue = nodesMap[uuid]?.[paramKey] || '';
            const fieldId = `param-${uuid}`;

            // Get the clean description of the parameter
            const raw_description = item['custom-description'] || '';
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = raw_description;
            let html_free_description = tempDiv.textContent || tempDiv.innerText || "No description set in project overview.";
            let description = html_free_description.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();

            // Construct the input field
            const row = document.createElement('div');
            row.className = 'input-row';
            row.innerHTML = `
            <div class="tooltip-container">
              <div class="tooltip" data-tooltip="${description}">?</div>
                <label for="${fieldId}">${item['custom-name']}:</label>
              </div>
              <input type="text"
                     id="${fieldId}"
                     name="${item['custom-name']}"
                     placeholder="${defaultValue}">
            `;
            container.appendChild(row);
          });
        });
      }

      async function stopPipelineJob(jobId) {
        const logOutput = document.getElementById('logOutput');
        try {
          const resp = await fetch('/JIPipeRunner/stop_jipipe_job/', {
            method: 'POST', credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ job_id: jobId })
          });
          const text = await resp.text();
          if (!resp.ok) {
            logOutput.textContent += `\nFailed to stop job ${jobId}: ${resp.status}\n${text}`;
            return;
          }
          logOutput.textContent += `\nCanceling job ${jobId}`;
        } catch (err) {
          console.error('Error while calling stop_jipipe_job:', err);
        }
      }

      async function executePipelineJob() {
        const logOutput = document.getElementById('logOutput');
        const start_button = document.getElementById('startRunnerBtn');
        const stop_button = document.getElementById('stopRunnerBtn');
        const logContainer = logOutput.parentElement;
        logOutput.textContent = '';

        Object.entries(pipelineConfig.graph.nodes).forEach(([uuid, node]) => {
          if (node['jipipe:alias-id']?.includes('define-dataset-ids')) {
            const inputValue = document.getElementById(`dataset-id-${uuid}`).value.trim();
            if (inputValue) node['dataset-ids'] = inputValue.split(',').map(v => v.trim());
          }
          if (uuid in paramKeyByNodeUuid) {
            const userInput = document.getElementById(`param-${uuid}`).value.trim();
            if (userInput) node[paramKeyByNodeUuid[uuid]] = userInput;
          }
        });

        const response = await fetch('/JIPipeRunner/jipipe_start_job/', {
          method: 'POST', credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
          body: JSON.stringify(pipelineConfig)
        });

        if (!response.ok) {
          const errText = await response.text();
          logOutput.textContent = `Error ${response.status}: ${errText}`;
          return;
        }

        start_button.style.display = 'none';
        stop_button.style.display = 'block';

        const { job_id: jobId } = await response.json();
        addRunningJob(jobId);

        stop_button.replaceWith(stop_button.cloneNode(true));
        const freshStopBtn = document.getElementById('stopRunnerBtn');
        freshStopBtn.addEventListener('click', event => {
          event.preventDefault();
          if (confirm(`Are you sure you want to cancel job ${jobId}?`)) {
            stopPipelineJob(jobId);
            removeRunningJob(jobId);
          }
        });

        let finished = false;
        let previousLogLength = 0;

        while (!finished) {
          const logResp = await fetch(`/JIPipeRunner/fetch_jipipe_logs/${jobId}/`, { credentials: 'same-origin' });
          if (!logResp.ok) {
            logOutput.textContent += `\nError fetching logs: ${logResp.status}`;
            return;
          }
          const { status, logs } = await logResp.json();
          if (logs.length > previousLogLength) {
            const newLines = logs.slice(previousLogLength).join('\n') + '\n';
            logOutput.textContent += newLines;
            logContainer.scrollTop = logContainer.scrollHeight;
            previousLogLength = logs.length;
          }
          finished = (status === 'finished');
          if (!finished) await new Promise(resolve => setTimeout(resolve, 2000));
        }

        removeRunningJob(jobId);
        freshStopBtn.style.display = 'none';
        start_button.style.display = 'block';
      }

      // Initialization: fetch config and render UI
      try {
        const projectId = '{{ project_id }}';
        document.getElementById('startRunnerBtn').addEventListener('click', event => {
          event.preventDefault();
          executePipelineJob();
        });

        pipelineConfig = await fetchPipelineConfig(projectId);
        const nodesMap = pipelineConfig.graph.nodes;
        displayNodeSummary(nodesMap);
        createDatasetInputFields(nodesMap);
        createParameterFields(
          pipelineConfig['additional-metadata']['org.hkijena.jipipe:pipeline-parameters'],
          nodesMap
        );
      } catch (error) {
        const container = document.getElementById('jipipe_runner_container');
        container.innerHTML = `<p class="error">Error loading configuration: ${error.message}</p>`;
        console.error(error);
      }
    })();
  </script>
</body>
</html>
